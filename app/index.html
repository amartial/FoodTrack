<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>FoodTruck – Disponibilités</title>

    <!-- FullCalendar CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css">
  </head>

  <body>
    <!-- Écran login / register -->
    <div id="authContainer">
      <div class="card">
        <h2>FoodTruck.be - Inscription</h2>
        <p style="font-size: 0.9rem; text-align: center;">
          Crée ton compte pour gérer ton agenda de FoodTruck.
        </p>
        <form id="authForm">
          <label>
            Nom du FoodTruck
            <input
              type="text"
              id="truckName"
              placeholder="Ex: Kebab Express"
              required
            />
          </label>

          <label>
            Spécialité
            <input
              type="text"
              id="truckSpec"
              placeholder="Ex: Kebab"
              required
            />
          </label>

          <label>
            Email
            <input
              type="email"
              id="email"
              placeholder="tonmail@exemple.com"
              required
            />
          </label>

          <label>
            Mot de passe
            <input
              type="password"
              id="password"
              placeholder="••••••••"
              required
            />
          </label>

          <button type="submit">Accéder à mon agenda</button>
        </form>
      </div>
    </div>

    <!-- App agenda -->
    <div id="appContainer" style="display: none;">
      <h1>
        Agenda de
        <span id="truckTitle">Mon FoodTruck</span>
      </h1>
      <p>
        Spécialité :
        <span id="truckSubtitle">Kebab</span>
      </p>

      <p>Clique sur les jours où ton FoodTruck est disponible.</p>

      <div id="calendar"></div>

      <div id="selected">
        <h3>Dates sélectionnées :</h3>
        <ul id="datesList"></ul>

        <button onclick="saveDates()">Enregistrer mes dates</button>
      </div>

      <div id="randomChoice">
        <h3>Tournée proposée (3 jours au hasard) :</h3>
        <ul id="randomList"></ul>
      </div>
    </div>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <script>
      let selectedDates = [];
      let calendar;

      let myTruckName = "Mon FoodTruck";
      let myTruckSpec = "Kebab";

      const otherTrucks = [
        { name: "Taco Mania", spec: "Tacos" },
        { name: "La Pizza Mobile", spec: "Pizza au feu de bois" },
        { name: "Burger Road", spec: "Burgers" },
        { name: "Waffle Street", spec: "Gaufres" },
        { name: "Vegan Wheels", spec: "Vegan bowls" },
        { name: "Sushi Van", spec: "Sushi" },
      ];

      document.addEventListener("DOMContentLoaded", function () {
        const authForm = document.getElementById("authForm");

        authForm.addEventListener("submit", function (e) {
          e.preventDefault();

          const nameInput = document.getElementById("truckName").value.trim();
          const specInput = document.getElementById("truckSpec").value.trim();

          myTruckName = nameInput || "Mon FoodTruck";
          myTruckSpec = specInput || "Kebab";

          document.getElementById("truckTitle").textContent = myTruckName;
          document.getElementById("truckSubtitle").textContent = myTruckSpec;

          // on cache le login, on montre l agenda
          document.getElementById("authContainer").style.display = "none";
          document.getElementById("appContainer").style.display = "block";

          initCalendar();
        });
      });

      function initCalendar() {
        const calendarEl = document.getElementById("calendar");

        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          locale: "fr",
          selectable: true,
          dateClick: function (info) {
            const date = info.dateStr;

            if (selectedDates.includes(date)) {
              selectedDates = selectedDates.filter((d) => d !== date);
              calendar.getEvents().forEach((ev) => {
                if (ev.startStr === date) ev.remove();
              });
            } else {
              selectedDates.push(date);
              calendar.addEvent({
                title: "Disponible",
                start: date,
                color: "#22c55e",
              });
            }

            refreshList();
          },
        });

        calendar.render();
      }

      function refreshList() {
        const ul = document.getElementById("datesList");
        ul.innerHTML = "";
        selectedDates.forEach((d) => {
          const li = document.createElement("li");
          li.textContent = d;
          ul.appendChild(li);
        });
      }

      function getRandomSample(arr, n) {
        const copy = [...arr];
        const sample = [];
        const count = Math.min(n, copy.length);

        for (let i = 0; i < count; i++) {
          const idx = Math.floor(Math.random() * copy.length);
          sample.push(copy[idx]);
          copy.splice(idx, 1);
        }
        return sample;
      }

      function formatDate(year, month, day) {
        const m = String(month + 1).padStart(2, "0");
        const d = String(day).padStart(2, "0");
        return `${year}-${m}-${d}`;
      }

      function saveDates() {
        if (selectedDates.length === 0) {
          alert("Aucune date sélectionnée.");
          return;
        }

        const ulRandom = document.getElementById("randomList");
        ulRandom.innerHTML = "";
        const chosen = getRandomSample(selectedDates, 3);
        chosen.forEach((d) => {
          const li = document.createElement("li");
          li.textContent = d;
          ulRandom.appendChild(li);
        });

        calendar.removeAllEvents();

        selectedDates.forEach((date) => {
          calendar.addEvent({
            title: `${myTruckName} - ${myTruckSpec}`,
            start: date,
            color: "#22c55e",
          });
        });

        const current = calendar.getDate();
        const year = current.getFullYear();
        const month = current.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = formatDate(year, month, day);

          if (selectedDates.includes(dateStr)) continue;

          const rand = Math.random();

          if (rand < 0.4) {
            calendar.addEvent({
              title: "Créneau libre",
              start: dateStr,
              color: "#38bdf8",
            });
          } else {
            const truck =
              otherTrucks[Math.floor(Math.random() * otherTrucks.length)];
            calendar.addEvent({
              title: `Déjà pris - ${truck.name} (${truck.spec})`,
              start: dateStr,
              color: "#f97316",
            });
          }
        }

        alert(
          "Tes dates sont enregistrées (démo). Tes jours sont marqués avec ton FoodTruck."
        );
      }
    </script>
  </body>
</html>
